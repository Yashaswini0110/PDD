pipeline {
    agent any

    environment {
        PROJECT_ID   = 'productdesigndev'
        REGION       = 'us-central1'
        REPO_NAME    = 'clauseclear'
        SERVICE_NAME = 'clauseclear-backend'
        IMAGE        = "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${SERVICE_NAME}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'ls -la'
            }
        }

        stage('Docker Build') {
            steps {
                sh "docker build -t ${IMAGE}:latest ."
            }
        }

        stage('Push to Artifact Registry') {
            steps {
                withCredentials([file(credentialsId: 'gcp-sa-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                    sh '''
                        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
                        gcloud config set project ${PROJECT_ID}
                        gcloud auth configure-docker ${REGION}-docker.pkg.dev -q
                        docker push ${IMAGE}:latest
                    '''
                }
            }
        }

        stage('Deploy to Cloud Run') {
            steps {
                script {
                    // Build env vars - start with required
                    def envVars = "GEMINI_MODEL_NAME=gemini-2.0-flash"
                    
                    // Try to add optional credentials (will skip if not found)
                    def hasGemini = false
                    def hasMongo = false
                    
                    // Check and add gemini-api-key if available
                    try {
                        withCredentials([string(credentialsId: 'gemini-api-key', variable: 'GEMINI_API_KEY')]) {
                            if (env.GEMINI_API_KEY) {
                                envVars += ",GEMINI_API_KEY=${env.GEMINI_API_KEY}"
                                hasGemini = true
                            }
                        }
                    } catch (Exception e) {
                        echo "INFO: gemini-api-key credential not configured. Deploying without it."
                        echo "      You can add it later via Cloud Run console or Jenkins credentials."
                    }
                    
                    // Check and add mongo-uri if available
                    try {
                        withCredentials([string(credentialsId: 'mongo-uri', variable: 'MONGO_URI')]) {
                            if (env.MONGO_URI) {
                                envVars += ",MONGO_URI=${env.MONGO_URI}"
                                hasMongo = true
                            }
                        }
                    } catch (Exception e) {
                        echo "INFO: mongo-uri credential not configured. Deploying without it."
                        echo "      You can add it later via Cloud Run console or Jenkins credentials."
                    }
                    
                    // Deploy (required credential)
                    withCredentials([file(credentialsId: 'gcp-sa-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                        sh """
                            gcloud auth activate-service-account --key-file=\$GOOGLE_APPLICATION_CREDENTIALS
                            gcloud config set project ${PROJECT_ID}
                            gcloud config set run/region ${REGION}
                            gcloud run deploy ${SERVICE_NAME} \\
                              --image ${IMAGE}:latest \\
                              --region ${REGION} \\
                              --platform managed \\
                              --allow-unauthenticated \\
                              --port 5055 \\
                              --set-env-vars ${envVars}
                        """
                    }
                    
                    if (!hasGemini) {
                        echo "⚠️  WARNING: GEMINI_API_KEY not set. LLM features will not work."
                        echo "   To enable: Add 'gemini-api-key' credential in Jenkins or set it in Cloud Run console."
                    }
                    if (!hasMongo) {
                        echo "ℹ️  INFO: MONGO_URI not set. MongoDB features will not work."
                        echo "   To enable: Add 'mongo-uri' credential in Jenkins or set it in Cloud Run console."
                    }
                }
            }
        }
    }
}

