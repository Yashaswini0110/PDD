<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocScanner - My Profile</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1" />
  </head>
  <body>
    <div class="container fade-in">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="nav-left">
          <div class="logo-circle">LOGO</div>
          <a href="/static/home.html" class="logo-text">DocScanner</a>
        </div>

        <div class="nav-right">
          <a
            href="/static/home.html"
            style="
              color: var(--text-color);
              text-decoration: none;
              font-weight: bold;
            "
            >Home</a
          >
          <a
            href="/static/uploads.html"
            style="
              color: var(--text-color);
              text-decoration: none;
              font-weight: bold;
            "
            >My Uploads</a
          >
          <a
            href="/static/profile.html"
            class="profile-ring"
            style="text-decoration: none"
          >
            <div class="avatar" id="userAvatar">U</div>
          </a>
          <button class="logout-icon" id="logoutBtn" title="Logout">
            <svg
              width="40"
              height="40"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </nav>

      <div class="card" style="max-width: 600px; margin: 0 auto">
        <h2
          style="
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 2rem;
          "
        >
          My Profile
        </h2>

        <div style="text-align: center; margin-bottom: 2rem">
          <div
            class="avatar"
            style="
              width: 100px;
              height: 100px;
              margin: 0 auto;
              font-size: 2.5rem;
              border-width: 4px;
            "
            id="largeAvatar"
          >
            U
          </div>
          <p style="color: #888; margin-top: 1rem" id="displayEmail"></p>
          <button
            class="btn"
            id="editProfileBtn"
            style="width: auto; padding: 5px 20px; margin-top: 1rem"
          >
            Edit Profile
          </button>
        </div>

        <form id="profileForm">
          <fieldset
            id="profileFields"
            disabled
            style="border: none; padding: 0"
          >
            <div class="form-group">
              <label style="color: #888; font-size: 0.9rem">First Name</label>
              <input type="text" id="pFirstName" required />
            </div>
            <div class="form-group">
              <label style="color: #888; font-size: 0.9rem">Last Name</label>
              <input type="text" id="pLastName" required />
            </div>
            <div class="form-group">
              <label style="color: #888; font-size: 0.9rem">Phone</label>
              <input type="tel" id="pPhone" required />
            </div>
            <div class="form-group">
              <label style="color: #888; font-size: 0.9rem">Address</label>
              <textarea id="pAddress" rows="3" required></textarea>
            </div>

            <div
              id="securitySection"
              style="
                display: none;
                margin-top: 2rem;
                padding-top: 1rem;
                border-top: 1px solid #333;
              "
            >
              <h3 style="font-size: 1.2rem; margin-bottom: 1rem">
                Security Settings
              </h3>
              <div class="form-group">
                <label style="color: #888; font-size: 0.9rem"
                  >New Password (Optional)</label
                >
                <input
                  type="password"
                  id="newPassword"
                  placeholder="Leave blank to keep current"
                />
              </div>
            </div>
          </fieldset>

          <div
            id="saveBtnContainer"
            style="display: none; margin-top: 2rem; text-align: center"
          >
            <button
              type="submit"
              class="btn btn-primary"
              style="width: 100%; margin-bottom: 1rem"
            >
              Save Changes
            </button>
            <button
              type="button"
              class="btn"
              id="cancelEditBtn"
              style="
                width: auto;
                background: transparent;
                color: #888;
                border: none;
              "
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import {
        signOut,
        onAuthStateChanged,
        updatePassword,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let currentUser = null;

      // Auth Check & Load Profile
      onAuthStateChanged(auth, async (user) => {
        if (!user && !sessionStorage.getItem("dev_bypass")) {
          window.location.href = "/static/index.html";
          return;
        }

        currentUser = user;
        const uid = user ? user.uid : "dev-user";

        try {
          const resp = await fetch(`/users/${uid}`);
          if (resp.ok) {
            const userData = await resp.json();
            populateProfile(userData);
          }
        } catch (e) {
          console.error("Failed to load profile", e);
        }

        if (user)
          document.getElementById("displayEmail").textContent = user.email;
      });

      function populateProfile(data) {
        const initial = data.firstName.charAt(0).toUpperCase();
        document.getElementById("userAvatar").textContent = initial;
        document.getElementById("largeAvatar").textContent = initial;

        document.getElementById("pFirstName").value = data.firstName;
        document.getElementById("pLastName").value = data.lastName;
        document.getElementById("pPhone").value = data.phone;
        document.getElementById("pAddress").value = data.address;

        const form = document.getElementById("profileForm");
        form.dataset.uid = data.uid;
        form.dataset.dob = data.dob;
        form.dataset.email = data.email;
      }

      // Edit/View Mode Logic
      const profileFields = document.getElementById("profileFields");
      const editBtn = document.getElementById("editProfileBtn");
      const saveBtnContainer = document.getElementById("saveBtnContainer");
      const securitySection = document.getElementById("securitySection");
      const cancelBtn = document.getElementById("cancelEditBtn");

      function toggleEditMode(isEditing) {
        profileFields.disabled = !isEditing;
        saveBtnContainer.style.display = isEditing ? "block" : "none";
        securitySection.style.display = isEditing ? "block" : "none";
        editBtn.style.display = isEditing ? "none" : "inline-block";
      }

      editBtn.addEventListener("click", () => toggleEditMode(true));
      cancelBtn.addEventListener("click", () => toggleEditMode(false));

      // Update Profile
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.target;
          const newPass = document.getElementById("newPassword").value;

          try {
            if (newPass && currentUser) {
              await updatePassword(currentUser, newPass);
              alert("Password updated successfully!");
            }

            const updateData = {
              uid: form.dataset.uid,
              firstName: document.getElementById("pFirstName").value,
              lastName: document.getElementById("pLastName").value,
              phone: document.getElementById("pPhone").value,
              address: document.getElementById("pAddress").value,
              email: form.dataset.email,
              dob: form.dataset.dob,
            };

            const resp = await fetch("/users/update", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updateData),
            });

            if (resp.ok) {
              alert("Profile updated!");
              toggleEditMode(false);
              populateProfile(updateData); // Refresh UI
            } else {
              throw new Error("Backend update failed");
            }
          } catch (error) {
            console.error(error);
            alert("Update failed: " + error.message);
          }
        });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        if (sessionStorage.getItem("dev_bypass")) {
          sessionStorage.removeItem("dev_bypass");
          window.location.href = "/static/index.html";
          return;
        }
        signOut(auth).then(() => (window.location.href = "/static/index.html"));
      });
    </script>
  </body>
</html>
