<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocScanner - My Uploads</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1" />
  </head>
  <body>
    <div class="container fade-in">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="nav-left">
          <div class="logo-circle">LOGO</div>
          <a href="/static/home.html" class="logo-text">DocScanner</a>
        </div>

        <div class="nav-right">
          <a
            href="/static/home.html"
            style="
              color: var(--text-color);
              text-decoration: none;
              font-weight: bold;
            "
            >Home</a
          >
          <a
            href="/static/uploads.html"
            style="
              color: var(--accent-color);
              text-decoration: none;
              font-weight: bold;
            "
            >My Uploads</a
          >
          <a
            href="/static/profile.html"
            class="profile-ring"
            style="text-decoration: none"
          >
            <div class="avatar" id="userAvatar">U</div>
          </a>
          <button class="logout-icon" id="logoutBtn" title="Logout">
            <svg
              width="40"
              height="40"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </nav>

      <div style="margin-bottom: 2rem">
        <h1 class="neon-text">My Uploads</h1>
        <p style="color: #888">View your previously analyzed documents.</p>
      </div>

      <div
        id="uploadsList"
        class="history-grid"
        style="
          display: grid;
          gap: 1rem;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        "
      >
        <!-- Uploads will be injected here -->
        <p id="loadingMsg">Loading your documents...</p>
      </div>

      <div
        id="emptyMsg"
        style="display: none; text-align: center; margin-top: 3rem"
      >
        <h3>No uploads found</h3>
        <p>You haven't uploaded any documents yet.</p>
        <button
          class="btn btn-primary"
          onclick="location.href='/static/home.html'"
          style="max-width: 200px; margin-top: 1rem"
        >
          Upload Now
        </button>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import {
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let currentUid = null;

      // Auth Check
      if (auth) {
        onAuthStateChanged(auth, async (user) => {
          if (!user && !sessionStorage.getItem("dev_bypass")) {
            window.location.href = "/static/index.html";
            return;
          }

          currentUid = user ? user.uid : "dev-user";

          // Load Avatar
          try {
            const resp = await fetch(`/users/${currentUid}`);
            if (resp.ok) {
              const userData = await resp.json();
              document.getElementById("userAvatar").textContent =
                userData.firstName.charAt(0).toUpperCase();
            }
          } catch (e) {
            console.error(e);
          }

          loadUploads();
        });
      } else {
        // Firebase not configured - allow dev bypass
        console.warn("Firebase not configured. Using dev mode.");
        sessionStorage.setItem("dev_bypass", "true");
        currentUid = "dev-user";
        loadUploads();
      }

      async function loadUploads() {
        try {
          const resp = await fetch(`/users/${currentUid}/history`);
          if (!resp.ok) return;
          const history = await resp.json();

          document.getElementById("loadingMsg").style.display = "none";

          if (history.length > 0) {
            const list = document.getElementById("uploadsList");
            list.innerHTML = history
              .map(
                (job) => `
                        <div class="card" style="cursor: pointer; transition: transform 0.2s;" onclick="location.href='/static/results.html?job_id=${
                          job.job_id
                        }'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="font-size: 2rem;">ðŸ“„</div>
                                <div style="text-align: right;">
                                    <span style="font-size: 0.8rem; background: var(--input-bg); padding: 4px 8px; border-radius: 4px;">
                                        ${new Date(
                                          job.created_at
                                        ).toLocaleDateString()}
                                    </span>
                                </div>
                            </div>
                            <h3 style="color: var(--accent-color); margin-bottom: 0.5rem; word-break: break-all;">${
                              job.filename
                            }</h3>
                            
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                                    <span style="color: var(--error-color); font-weight: bold;">High Risk: ${
                                      job.analysis_summary?.RED || 0
                                    }</span>
                                    <span style="color: #e6b800; font-weight: bold;">Med Risk: ${
                                      job.analysis_summary?.YELLOW || 0
                                    }</span>
                                </div>
                            </div>
                        </div>
                    `
              )
              .join("");
          } else {
            document.getElementById("emptyMsg").style.display = "block";
          }
        } catch (e) {
          console.error("Failed to load history", e);
          document.getElementById("loadingMsg").textContent =
            "Failed to load documents.";
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        if (sessionStorage.getItem("dev_bypass")) {
          sessionStorage.removeItem("dev_bypass");
          window.location.href = "/static/index.html";
          return;
        }
        signOut(auth).then(() => (window.location.href = "/static/index.html"));
      });
    </script>
  </body>
</html>
