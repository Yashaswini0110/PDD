<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocScanner - Sign Up</title>
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div class="container auth-container fade-in">
      <h1 class="neon-text" style="text-align: center; margin-bottom: 2rem">
        Join Us
      </h1>

      <div class="card">
        <h2 style="text-align: center">Create Account</h2>

        <form id="signupForm">
          <input type="text" id="firstName" placeholder="First Name" required />
          <input type="text" id="lastName" placeholder="Last Name" required />
          <input type="date" id="dob" required style="color-scheme: dark" />
          <input type="email" id="email" placeholder="Email Address" required />
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />
          <input type="tel" id="phone" placeholder="Phone Number" required />
          <textarea
            id="address"
            placeholder="Address"
            rows="2"
            required
          ></textarea>

          <div
            id="validation-msg"
            style="
              color: var(--error-color);
              margin-bottom: 1rem;
              font-size: 0.9rem;
            "
          ></div>

          <button type="submit" class="btn btn-primary" id="nextBtn">
            Next: Payment
          </button>
        </form>
        <div style="text-align: center; margin-top: 1rem">
          <a
            href="/static/index.html"
            style="color: #888; text-decoration: none; font-size: 0.9rem"
            >Back to Login</a
          >
        </div>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      document
        .getElementById("signupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("validation-msg");
          const btn = document.getElementById("nextBtn");
          msg.textContent = "";

          // --- Validation Logic ---
          const phone = document.getElementById("phone").value;

          // Phone Regex: Basic 10+ digits
          if (phone.length < 10) {
            msg.textContent = "Invalid Phone Number.";
            return;
          }

          // --- Firebase Create User ---
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          btn.disabled = true;
          btn.textContent = "Creating Account...";

          try {
            const userCredential = await createUserWithEmailAndPassword(
              auth,
              email,
              password
            );
            const user = userCredential.user;

            // --- Store Profile Data in Backend ---
            const profileData = {
              uid: user.uid,
              email: email,
              firstName: document.getElementById("firstName").value,
              lastName: document.getElementById("lastName").value,
              dob: document.getElementById("dob").value,
              phone: phone,
              address: document.getElementById("address").value,
            };

            // Store in local storage for the payment page to use if needed,
            // but primarily send to backend now.
            sessionStorage.setItem("tempProfile", JSON.stringify(profileData));

            const resp = await fetch("/users/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(profileData),
            });

            if (!resp.ok) throw new Error("Failed to save profile on server");

            // Redirect to Payment
            window.location.href = "/static/payment.html";
          } catch (error) {
            console.error(error);
            msg.textContent = "Signup Failed: " + error.message;
            btn.disabled = false;
            btn.textContent = "Next: Payment";
          }
        });
    </script>
  </body>
</html>
