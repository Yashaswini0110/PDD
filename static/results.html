<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DocScanner - Analysis Report</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  </head>
  <body>
    <div class="container fade-in">
      <!-- Navbar -->
      <nav class="navbar">
        <div class="nav-left">
          <div class="logo-circle">LOGO</div>
          <a href="/static/home.html" class="logo-text">DocScanner</a>
        </div>

        <div class="nav-right">
          <a
            href="/static/home.html"
            style="
              color: var(--text-color);
              text-decoration: none;
              font-weight: bold;
            "
            >Home</a
          >
          <a
            href="/static/uploads.html"
            style="
              color: var(--text-color);
              text-decoration: none;
              font-weight: bold;
            "
            >My Uploads</a
          >
          <a
            href="/static/profile.html"
            class="profile-ring"
            style="text-decoration: none"
          >
            <div class="avatar" id="userAvatar">U</div>
          </a>
          <button class="logout-icon" id="logoutBtn" title="Logout">
            <svg
              width="40"
              height="40"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </nav>

      <header
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
        "
      >
        <h2 class="neon-text">Analysis Report</h2>
        <div>
          <button
            class="btn"
            onclick="location.href='/static/home.html'"
            style="width: auto; margin-right: 10px"
          >
            New Scan
          </button>
          <button class="btn btn-primary" id="downloadBtn" style="width: auto">
            Download Report
          </button>
        </div>
      </header>

      <!-- Risk Overview -->
      <div class="card" id="reportContent">
        <h3>Overall Risk Assessment</h3>

        <div class="risk-score">
          <div class="risk-marker" id="riskMarker" style="left: 0%"></div>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
          "
        >
          <span>Low Risk</span>
          <span>Medium</span>
          <span>High Risk</span>
        </div>

        <div
          style="
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
          "
        >
          <div
            style="
              text-align: center;
              padding: 1rem;
              background: var(--input-bg);
              border-radius: 4px;
              border: 1px solid var(--border-color);
            "
          >
            <h1 id="redCount" style="color: var(--error-color)">0</h1>
            <p>High Risk Clauses</p>
          </div>
          <div
            style="
              text-align: center;
              padding: 1rem;
              background: var(--input-bg);
              border-radius: 4px;
              border: 1px solid var(--border-color);
            "
          >
            <h1 id="yellowCount" style="color: #d4a017">0</h1>
            <p>Medium Risk Clauses</p>
          </div>
          <div
            style="
              text-align: center;
              padding: 1rem;
              background: var(--input-bg);
              border-radius: 4px;
              border: 1px solid var(--border-color);
            "
          >
            <h1 id="greenCount" style="color: var(--success-color)">0</h1>
            <p>Safe Clauses</p>
          </div>
        </div>
      </div>

      <!-- High Risk Clauses -->
      <div class="card">
        <h3 style="color: var(--error-color)">High Risk Clauses</h3>
        <div id="redClauses"></div>
      </div>

      <!-- Medium Risk Clauses -->
      <div class="card">
        <h3 style="color: #d4a017">Medium Risk Clauses</h3>
        <div id="yellowClauses"></div>
      </div>

      <!-- Safe Clauses -->
      <div class="card">
        <h3 style="color: var(--success-color)">Safe Clauses</h3>
        <div id="greenClauses"></div>
      </div>

      <!-- Chat Interface -->
      <div class="card">
        <h3>Ask the AI Lawyer</h3>
        <div class="chat-box" id="chatBox">
          <div class="message ai-msg">
            Hello! I've analyzed your document. Ask me anything about the
            clauses or risks found.
          </div>
        </div>

        <form id="chatForm" style="display: flex; gap: 10px">
          <input
            type="text"
            id="queryInput"
            placeholder="E.g., What is the termination notice period?"
            style="margin-bottom: 0"
          />
          <button type="submit" class="btn btn-primary" style="width: auto">
            Send
          </button>
        </form>
      </div>
    </div>

    <script type="module">
      import { auth } from "/static/js/firebase-config.js";
      import {
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      let currentUid = "dev-user";

      // Auth Check with Developer Bypass
      onAuthStateChanged(auth, async (user) => {
        if (!user && !sessionStorage.getItem("dev_bypass")) {
          window.location.href = "/static/index.html";
          return;
        }

        // Load basic avatar info
        currentUid = user ? user.uid : "dev-user";
        try {
          const resp = await fetch(`/users/${currentUid}`);
          if (resp.ok) {
            const userData = await resp.json();
            document.getElementById("userAvatar").textContent =
              userData.firstName.charAt(0).toUpperCase();
          }
        } catch (e) {
          console.error(e);
        }

        // Load analysis after we have the UID
        loadAnalysis();
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        if (sessionStorage.getItem("dev_bypass")) {
          sessionStorage.removeItem("dev_bypass");
          window.location.href = "/static/index.html";
          return;
        }
        signOut(auth).then(() => (window.location.href = "/static/index.html"));
      });

      const urlParams = new URLSearchParams(window.location.search);
      const jobId = urlParams.get("job_id");

      if (!jobId) {
        alert("No Job ID found.");
        window.location.href = "/static/home.html";
      }

      // Fetch Analysis Data & Chat History
      async function loadAnalysis() {
        try {
          // Pass the UID so we don't overwrite the job ownership with "dev-user"
          const resp = await fetch(
            `/analyze/${jobId}/clauses?uid=${currentUid}`,
            {
              method: "POST",
            }
          );
          const data = await resp.json();
          updateUI(data);
          loadChatHistory(); // Load saved chat
        } catch (e) {
          console.error(e);
          alert("Failed to load analysis.");
        }
      }

      async function loadChatHistory() {
        try {
          const resp = await fetch(`/analyze/${jobId}/chat`);
          if (!resp.ok) return;
          const history = await resp.json();

          history.forEach((item) => {
            addMessage(item.query, "user-msg");
            addMessage(item.answer, "ai-msg");
          });
        } catch (e) {
          console.error("Failed to load chat history", e);
        }
      }

      function updateUI(data) {
        const summary = data.summary;
        document.getElementById("redCount").textContent = summary.RED || 0;
        document.getElementById("yellowCount").textContent =
          summary.YELLOW || 0;
        document.getElementById("greenCount").textContent = summary.GREEN || 0;

        const total = data.total_clauses || 1;
        const weightedScore =
          ((summary.RED * 10 + summary.YELLOW * 5) / total) * 10;
        const percentage = Math.min(Math.max(weightedScore, 0), 100);

        document.getElementById("riskMarker").style.left = `${percentage}%`;

        // Display clauses grouped by risk level
        renderClauses(data.clauses.red || [], "redClauses");
        renderClauses(data.clauses.yellow || [], "yellowClauses");
        renderClauses(data.clauses.green || [], "greenClauses");
      }

      function renderClauses(clauses, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        if (clauses.length === 0) {
          container.innerHTML = "<p style='color: #888; font-style: italic;'>No clauses in this category.</p>";
          return;
        }

        clauses.forEach((clause) => {
          const clauseDiv = document.createElement("div");
          clauseDiv.style.cssText = "margin-bottom: 1.5rem; padding: 1rem; background: var(--input-bg); border-radius: 4px; border: 1px solid var(--border-color);";
          
          const clauseHeader = document.createElement("div");
          clauseHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;";
          
          const clauseId = document.createElement("span");
          clauseId.style.cssText = "font-weight: bold; color: var(--text-color);";
          clauseId.textContent = `Clause ${clause.clause_id} (Page ${clause.page})`;
          clauseHeader.appendChild(clauseId);
          
          clauseDiv.appendChild(clauseHeader);
          
          const clauseText = document.createElement("p");
          clauseText.style.cssText = "margin: 0.5rem 0; color: var(--text-color); line-height: 1.5;";
          clauseText.textContent = clause.text;
          clauseDiv.appendChild(clauseText);
          
          if (clause.reasons && clause.reasons.length > 0) {
            const reasonsDiv = document.createElement("div");
            reasonsDiv.style.cssText = "margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);";
            const reasonsLabel = document.createElement("strong");
            reasonsLabel.style.cssText = "color: var(--text-color); font-size: 0.9rem;";
            reasonsLabel.textContent = "Explanation: ";
            reasonsDiv.appendChild(reasonsLabel);
            const reasonsText = document.createElement("span");
            reasonsText.style.cssText = "color: #888; font-size: 0.9rem;";
            reasonsText.textContent = clause.reasons.join(" ");
            reasonsDiv.appendChild(reasonsText);
            clauseDiv.appendChild(reasonsDiv);
          }
          
          container.appendChild(clauseDiv);
        });
      }

      // Chat Logic
      const chatBox = document.getElementById("chatBox");
      const chatForm = document.getElementById("chatForm");
      const queryInput = document.getElementById("queryInput");

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const query = queryInput.value.trim();
        if (!query) return;

        addMessage(query, "user-msg");
        queryInput.value = "";

        const loadingId = addMessage("Thinking...", "ai-msg");

        try {
          const resp = await fetch(`/query_llm/${jobId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query, top_k: 3 }),
          });
          const data = await resp.json();

          document.getElementById(loadingId).remove();
          // Use answer_llm (simple explanation) instead of base_answer
          const answer = data.answer_llm || data.base_answer || data.answer || "Sorry, I couldn't generate an answer.";
          addMessage(answer, "ai-msg");
        } catch (error) {
          document.getElementById(loadingId).textContent =
            "Error: " + error.message;
        }
      });

      function addMessage(text, className) {
        const div = document.createElement("div");
        div.className = `message ${className}`;
        div.textContent = text;
        div.id = "msg-" + Date.now();
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div.id;
      }

      // Download Report
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const element = document.getElementById("reportContent");
        const opt = {
          margin: 1,
          filename: `report-${jobId}.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };
        html2pdf().set(opt).from(element).save();
      });
    </script>
  </body>
</html>
